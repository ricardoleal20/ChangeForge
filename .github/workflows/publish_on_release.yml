# This file is autogenerated by maturin v1.4.0
# To update, run
#
#    maturin generate-ci github
#
name: Publish package on tag release üöÄ

on:
  push:
    tags:
      - "**"
      - "v[0-9]+.[0-9]+.[0-9]+"

permissions:
  contents: read

jobs:
  linux:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        target: [x86_64, x86]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      - name: Build wheels
        uses: PyO3/maturin-action@v1.49.4
        with:
          target: ${{ matrix.target }}
          args: --release --out dist --find-interpreter
          sccache: "true"
          manylinux: auto
          before-script-linux: |
            set -eux
            if command -v microdnf >/dev/null 2>&1; then
              microdnf -y install openssl-devel pkgconfig
            elif command -v dnf >/dev/null 2>&1; then
              dnf -y install openssl-devel pkgconfig
            elif command -v yum >/dev/null 2>&1; then
              yum -y install openssl-devel pkgconfig
            elif command -v apt-get >/dev/null 2>&1; then
              apt-get -y update
              apt-get -y install libssl-dev pkg-config
            elif command -v apk >/dev/null 2>&1; then
              apk add --no-cache openssl-dev pkgconfig
            else
              echo "No supported package manager found" >&2
              exit 1
            fi
      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ runner.os }}-${{ matrix.target }}
          path: dist/*

  linux-aarch64:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build wheels (aarch64) ‚öôÔ∏è
        uses: uraimo/run-on-arch-action@v2
        with:
          arch: aarch64
          distro: ubuntu22.04
          githubToken: ${{ github.token }}
          install: |
            set -eux
            apt-get update
            DEBIAN_FRONTEND=noninteractive apt-get install -y \
              python3 python3-venv python3-pip pkg-config build-essential curl ca-certificates \
              clang lld
            update-ca-certificates || true
            # Rust toolchain for aarch64
            curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
            . "$HOME/.cargo/env"
            python3 -m pip install --upgrade pip
            pip3 install maturin
          run: |
            set -eux
            . "$HOME/.cargo/env"
            cd "$GITHUB_WORKSPACE"
            export CC=clang
            export CXX=clang++
            export CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=clang
            export RUSTFLAGS="${RUSTFLAGS:-} -C link-arg=-fuse-ld=lld -C debuginfo=0"
            export CARGO_PROFILE_RELEASE_LTO=false
            maturin build --release --out dist --find-interpreter
      - name: Upload wheels (aarch64) üì§
        uses: actions/upload-artifact@v4
        with:
          name: wheels-Linux-aarch64
          path: dist/*

  windows:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        target: [x64, x86]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          architecture: ${{ matrix.target }}
      - name: Build wheels ‚öôÔ∏è
        uses: PyO3/maturin-action@v1.49.4
        with:
          target: ${{ matrix.target }}
          args: --release --out dist -i python3.12
          sccache: "true"

      - name: Upload wheels üì§
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ runner.os }}-${{ matrix.target }}
          path: dist/*

  macos:
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        target: [x86_64, aarch64]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Build wheels ‚öôÔ∏è
        uses: PyO3/maturin-action@v1.49.4
        with:
          target: ${{ matrix.target }}
          args: --release --out dist -i python3.12
          sccache: "true"
      - name: Upload wheels üì§
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ runner.os }}-${{ matrix.target }}
          path: dist/*

  sdist:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build sdist ‚öôÔ∏è
        uses: PyO3/maturin-action@v1.49.4
        with:
          command: sdist
          args: --out dist
      - name: Upload sdist üì§
        uses: actions/upload-artifact@v4
        with:
          name: wheels-sdist
          path: dist/*

  release:
    name: Release
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    needs: [linux, linux-aarch64, windows, macos, sdist]
    steps:
      - uses: actions/download-artifact@v4
        with:
          pattern: wheels-*
          merge-multiple: true
      - name: Publish to PyPI üì§
        uses: PyO3/maturin-action@v1.49.4
        env:
          MATURIN_PYPI_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
        with:
          command: upload
          args: --non-interactive --skip-existing *
